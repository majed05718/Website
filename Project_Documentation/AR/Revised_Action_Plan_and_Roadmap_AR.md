# خطة العمل المعدلة وخارطة الطريق

- **التاريخ:** 2025-11-09  
- **المالك:** المهندس البرمجي الرئيسي  
- **الهدف:** تحويل طموحات `Change_Implementation_Plan_CIP.md` إلى خارطة طريق واقعية تراعي وضع الشفرة الحالي وتجزئ المهام إلى حزم قابلة للتنفيذ.

---

## الملحمة 1: مواءمة طبقة قاعدة البيانات
**الغاية:** مواءمة طبقة الوصول إلى البيانات مع نمط الفهارس والمستودعات المذكور في الـ CIP عبر فهم الاعتماد الحالي على Supabase والتخطيط للانتقال خطوة بخطوة.

- **DB-01 – جرد استخدام Supabase**
  - *الوصف:* توثيق كل تفاعل مباشر مع Supabase داخل `/api/src/**` (الخدمات، الوحدات، الأدوات). تسجيل الجداول، الإجراءات المخزنة، عوامل التصفية، وأنماط الاستعلام في `docs/data-access/supabase-audit.md`.
  - *معيار الإنهاء:* جدول جرد + ملخص وصفي معتمد من فريق الخلفية.

- **DB-02 – رسم المخطط وإنشاء كيانات أولية**
  - *الوصف:* إعادة بناء مخططات جداول Supabase (باستخدام `supabase_schema.sql` والاستقصاء الحي) وإنشاء ملفات TypeORM تعكس البنية الحالية ومتطلبات الفهارس.
  - *الاعتماديات:* DB-01.
  - *معيار الإنهاء:* ملفات كيانات جديدة ضمن `/api/src/entities/` مع تعليقات TODO للعلاقات.

- **DB-03 – خطة الانتقال إلى المستودعات**
  - *الوصف:* إعداد خطة تفصيلية تشرح كيفية نقل كل خدمة من الاستدعاءات المباشرة لـ Supabase إلى نمط المستودع باستخدام الكيانات الجديدة.
  - *الاعتماديات:* DB-01, DB-02.
  - *معيار الإنهاء:* مستند في `docs/data-access/migration-plan.md` يضم مراحل التنفيذ وإدارة المخاطر.

- **DB-04 – استراتيجية تطبيق الفهارس**
  - *الوصف:* تحويل متطلبات الفهارس في CIP §2.2 إلى ترحيلات SQL قابلة للتنفيذ وتحديد تسلسل النشر.
  - *الاعتماديات:* DB-02 (فهم المخطط).
  - *معيار الإنهاء:* سكربتات SQL مراجعة وخطة استرجاع ضمن `database/migrations/pending`.

---

## الملحمة 2: إعادة بناء أساسيات الأمان و JWT
**الغاية:** تأسيس بنية مصادقة متينة تدعم رموز الوصول/التحديث، التخزين الآمن، والتحقق الشامل.

- **SEC-01 – تصميم تخزين رموز التحديث**
  - *الوصف:* تصميم نموذج البيانات (الجداول، سياسة الاحتفاظ، بيانات الجهاز) لتخزين رموز التحديث بشكل آمن في Supabase أو مخزن مخصص.
  - *معيار الإنهاء:* مخطط ERD + سكربتات ترحيل ضمن `database/migrations/pending`.

- **SEC-02 – مخطط خدمة المصادقة**
  - *الوصف:* تحديد بنية `AuthService` في NestJS والحراس والاستراتيجيات وواجهات DTO لإصدار الرموز وتدويرها وإلغائها، مع معالجة الأخطاء والتسجيل.
  - *الاعتماديات:* SEC-01.
  - *معيار الإنهاء:* مستند معماري في `docs/security/auth-service-blueprint.md`.

- **SEC-03 – تنفيذ أولي للخلفية**
  - *الوصف:* تنفيذ الوحدات الأساسية في NestJS (استراتيجيات، حراس، متحكمات) لدعم تسجيل الدخول والتحديث وتسجيل الخروج مع إرجاع ملفات تعريف ارتباط HttpOnly.
  - *الاعتماديات:* SEC-02.
  - *معيار الإنهاء:* اختبارات تكامل ناجحة تغطي إصدار/تحديث الرموز + تحديث توثيق الواجهة البرمجية.

- **SEC-04 – سياق المصادقة في الواجهة الأمامية والمعترضات**
  - *الوصف:* إنشاء سياق/مخزن مصادقة يتعامل مع ملفات تعريف الارتباط HttpOnly، يضيف معترضات Axios للتعامل مع 401، ويتولى سيناريوهات تسجيل الخروج الإجباري.
  - *الاعتماديات:* SEC-03.
  - *معيار الإنهاء:* اختبارات تكامل للواجهة الأمامية تؤكد التحديث الصامت واستمرارية الجلسة.

- **SEC-05 – تدقيق تغطية التحقق في DTO**
  - *الوصف:* تدقيق جميع DTO الحرجة لرصد الحقول التي تفتقر إلى `class-validator` ووضع خطة تحديث متوافقة مع متطلبات الأمان الجديدة.
  - *معيار الإنهاء:* قائمة تحقق مع ترتيب أولويات الإصلاحات للسبرنت القادم.

---

## الملحمة 3: إعادة هيكلة التهيئة البيئية
**الغاية:** إدخال تهيئة تعتمد على البيئة تتيح التبديل بين الإنتاج والتجارب بأمر واحد وفق ما ورد في الـ CIP.

- **ENV-01 – جرد المتغيرات والفجوات**
  - *الوصف:* توثيق استخدام المتغيرات البيئية في الواجهة الخلفية والأمامية وملفات PM2 والسكربتات، مع تحديد التناقضات مع متطلبات الـ CIP.
  - *معيار الإنهاء:* تقرير في `docs/config/env-inventory.md`.

- **ENV-02 – تصميم بنية التهيئة**
  - *الوصف:* صياغة هيكل المجلدات الجديد (`config/env/...`)، ترتيب التحميل، منطق اختيار البيئة (`APP_ENV`)، ومعاملات PM2.
  - *الاعتماديات:* ENV-01.
  - *معيار الإنهاء:* مستند تصميم + فرع إثبات مفهوم يبرهن التبديل بين البيئات.

- **ENV-03 – تحديث تشغيل الخلفية**
  - *الوصف:* تحديث `api/src/main.ts` وما يرتبط به لاستهلاك استراتيجية التهيئة الجديدة مع الحفاظ على سازجة التطوير المحلي.
  - *الاعتماديات:* ENV-02.
  - *معيار الإنهاء:* تشغيل الواجهة البرمجية بنجاح في التطوير/التجارب مع التهيئة الجديدة + اختبارات رجعية خضراء.

- **ENV-04 – مواءمة الواجهة الأمامية**
  - *الوصف:* تحديث ضبط Next.js (`next.config.js`, تحميل المتغيرات) وملفات النشر (PM2، السكربتات) للتوافق مع `APP_ENV`.
  - *الاعتماديات:* ENV-02.
  - *معيار الإنهاء:* تشغيل الواجهة الأمامية محليًا وفي بيئة التجارب مع اختيار عنوان الواجهة البرمجية الصحيح من التهيئة.

- **ENV-05 – تحديث إجراءات النشر الآلي**
  - *الوصف:* تعديل أدوات النشر (CI/CD والسكربتات) لضخ ملفات التهيئة الصحيحة وإعادة تشغيل PM2 بالمعاملات الجديدة.
  - *الاعتماديات:* ENV-03, ENV-04.
  - *معيار الإنهاء:* اختبار تشغيل تجريبي ناجح للنشر على بيئة التجارب.

---

## الملحمة 4: تدقيق وتحسين أداء الواجهة الأمامية
**الغاية:** تحقيق مكاسب أداء سريعة الأثر مع تأسيس آليات مراقبة وحماية من التراجع.

- **FE-01 – تدقيق أداء المكونات**
  - *الوصف:* تحليل المسارات الرئيسية (`/dashboard`, `/dashboard/properties`, `/dashboard/customers`) لضبط المكونات الثقيلة والنصوص العائقة ومشكلات الصور، وتوثيق النتائج في `docs/perf/frontend-audit.md`.
  - *معيار الإنهاء:* قائمة مرتبة بالمكونات مع توصيات المعالجة.

- **FE-02 – خطة تعميم تحسين الصور**
  - *الوصف:* وضع خطة منهجية لاستبدال `<img>` بـ `next/image`، مع تحديد استراتيجية أحجام الأصول، واعتبارات الـ CDN، وآليات fallback.
  - *الاعتماديات:* FE-01.
  - *معيار الإنهاء:* مستند معايير + قائمة مهام لكل مكون.

- **FE-03 – استراتيجية التحميل الديناميكي**
  - *الوصف:* جرد الاعتمادات الثقيلة المخصصة للمتصفح (مثل الرسوم البيانية، الخرائط) وتخطيط تبني `next/dynamic` مع عناصر تحميل بديلة وتكامل البث.
  - *الاعتماديات:* FE-01.
  - *معيار الإنهاء:* دليل تنفيذ + قائمة أولوية.

- **FE-04 – مكاسب فورية**
  - *الوصف:* تنفيذ التحسينات المستهدفة (أفضل 3 مكونات) التي تم تحديدها في FE-01، بما في ذلك `next/image`، `next/dynamic`، وحالات تحميل ملائمة لـ Suspense.
  - *الاعتماديات:* FE-01.
  - *معيار الإنهاء:* توثيق تحسن الأداء (Lighthouse/حجم الحزم) بعد التغيير.

- **FE-05 – حواجز المراقبة ومنع التراجع**
  - *الوصف:* دمج Lighthouse CI وتقارير حجم الحزم ضمن فحوصات PR، ووضع حدود تتماشى مع أهداف الـ CIP.
  - *الاعتماديات:* FE-04.
  - *معيار الإنهاء:* فحوصات آلية تمنع التراجع في المسارات الرئيسية.

---

## التسلسل والخطوات التالية
1. البدء بـ **FE-04 (المكاسب الفورية)** لتحقيق قيمة سريعة بالتوازي مع تدقيق الأداء (FE-01).  
2. إطلاق **ENV-01 / ENV-02** لتمهيد الطريق لأعمال الأمان والنشر.  
3. تنفيذ **DB-01** لتغذية الملحمتين المتعلقتين بالبيانات والمصادقة.  
4. استخدام نتائج التدقيق/الوثائق لتغذية سباقات التنفيذ، بحيث تنتقل كل ملحمة من الاكتشاف → التصميم → التنفيذ مع وضوح الاعتماديات.  
5. إعادة زيارة الـ CIP بعد كل معلم للتأكد من الاتساق وتعديل خارطة الطريق حسب المستجدات.

---

> تحوّل هذه الخارطة طموحات `Change_Implementation_Plan_CIP.md` إلى مهام مرحلية قابلة للتتبع. كل تذكرة قابلة للجدولة والتقدير والمتابعة بصورة مستقلة، مما يسمح بتقدم تدريجي مع الحفاظ على الاتساق الإستراتيجي.

