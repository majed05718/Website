#!/bin/bash

echo "ðŸŽ‰ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø±..."
echo ""

# Check .env files
if [ ! -f "api/.env" ]; then
    echo "âŒ api/.env Ù…ÙÙ‚ÙˆØ¯"
    exit 1
fi

if [ ! -f "Web/.env.local" ]; then
    echo "âŒ Web/.env.local Ù…ÙÙ‚ÙˆØ¯"
    exit 1
fi

echo "âœ… Ù…Ù„ÙØ§Øª Environment Ù…ÙˆØ¬ÙˆØ¯Ø©"
echo ""

# Backend
echo "ðŸ“¦ Backend..."
cd api
npm install --production
npm run build
cd ..
echo "âœ… Backend Ø¬Ø§Ù‡Ø²"
echo ""

# Frontend
echo "ðŸ“¦ Frontend..."
cd Web
npm install --production
npm run build
cd ..
echo "âœ… Frontend Ø¬Ø§Ù‡Ø²"
echo ""

# PM2 Config
echo "âš™ï¸  Ø¥Ù†Ø´Ø§Ø¡ PM2 config..."
cat > ecosystem.config.js << 'EOFPM2'
module.exports = {
  apps: [
    {
      name: 'backend',
      cwd: './api',
      script: 'dist/main.js',
      instances: 1,
      env: {
        NODE_ENV: 'production',
        PORT: 3001,
      },
      error_file: '/var/log/pm2/backend-error.log',
      out_file: '/var/log/pm2/backend-out.log',
      autorestart: true,
      max_memory_restart: '500M',
    },
    {
      name: 'frontend',
      cwd: './Web',
      script: 'node_modules/next/dist/bin/next',
      args: 'start -p 3000',
      instances: 1,
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: '/var/log/pm2/frontend-error.log',
      out_file: '/var/log/pm2/frontend-out.log',
      autorestart: true,
      max_memory_restart: '500M',
    },
  ],
};
EOFPM2

# Create logs dir
sudo mkdir -p /var/log/pm2
sudo chown -R $USER:$USER /var/log/pm2

# Start PM2
echo "ðŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
pm2 start ecosystem.config.js
pm2 save
pm2 startup

echo ""
echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù†Ø´Ø±!"
echo ""
pm2 status
